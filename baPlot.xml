<tool id="baPlot" name="Bland-Altman Plot">
  <description>Create pairwise BA plots to identify outliers.</description>
  <requirements>
    <requirement type="python-module">numpy</requirement>
    <requirement type="python-module">scipy</requirement>
    <requirement type="python-module">pandas</requirement>
    <requirement type="python-module">statsmodels</requirement>
    <requirement type="python-module">matplotlib</requirement>
  </requirements>
  <command interpreter="python">baPlot.py
      --input $input
      --design $design
      --ID $uniqID
      --ba $ba_plots
      --flag_dist $outlier_dist_plots
      --flag_sample $flag_sample
      --flag_feature $flag_feature
      --resid_cutoff $resid_cutoff
      --sample_flag_cutoff $sample_cutoff
      --feature_flag_cutoff $feature_cutoff

      #if $group
          --group $group

          #if $processOnly:
            --process_only $processOnly
          #end if
      #end if

  </command>
  <inputs>
    <param name="input" type="data" format="tabular" label="Wide Dataset" help="Input dataset in wide format and tab separated. If not tab separated see TIP below."/>
    <param name="design" type="data" format="tabular" label="Metadata File" help="Metadata file tab separated. Note you need a 'sampleID' column. If not tab separated see TIP below"/>
    <param name="uniqID" size="30" type="text" value="" label="Unique Compound ID" help="Name of the column in your Wide Dataset that has unique compound/gene IDs."/>
    <param name="resid_cutoff" type="text" size="30" value="3" label="Outlier Cutoff" help="Residual cutoff value, this value will flag samples whose residuals are â‰¥ to cutoff value."/>
    <param name="sample_cutoff" type="text" size="30" value="0.2" label="Sample Flag Cutoff" help="Flag a sample as 1, if the proportion of features within a sample that are outliers exceeds this cutoff.[Number between 0-1]"/>
    <param name="feature_cutoff" type="text" size="30" value="0.05" label="Feature Flag Cutoff" help="Flag a feature, if the proportion of times this feature was identified as an outlier exceeds this cutoff.[Number between 0-1]"/>
    <param name="group" type="text" size="30"  value="" optional="true" label="Group/Treatment [Optional]" help="Name of the column in your Metadata File that contains group classifications."/>
    <param name="processOnly" size="30" type="text" value="" optional="true" label="Group ID [Optional]" help="Name of the group(s) that you want to process. Separate multiple groupIDs with spaces. Leave blank to process all groups. Requires the group parameter."/>
  </inputs>
  <outputs>
    <data format="pdf" name="ba_plots" />
    <data format="pdf" name="outlier_dist_plots" />
    <data format="tabular" name="flag_sample"/>
    <data format="tabular" name="flag_feature"/>
  </outputs>
  <help>

.. class:: infomark

**TIP:** 
If your data is not TAB delimited, use *Text Manipulation-&gt;Convert*

--------------------------------------------------------------------------------

**What it does**

The Bland-Altman plot BA-Plot_ is commonly used to look at concordance of data
between samples. It is especially useful for looking at variability between
replicates. This script will generate BA-plots for all pairwise combinations of
samples, or if group information is provided it will only report pairwise
combinations within the group.

.. _BA-Plot: http://en.wikipedia.org/wiki/Bland%E2%80%93Altman_plot

A linear regression is performed on the BA-plots to identify samples whose
residuals are beyond a cutoff. For each compound (row) in the dataset, a sample
is flagged as an outlier if the Pearson normalized residuals are greater than a
cutoff.

Raw flags can be output by specifying the "Output Raw Flag Counts".
*flag_outlier_raw* is a table with compounds as rows and flag_outlier## as
columns, where the ## is incremented for each pairwise comparison between
samples. *flag_outlier_design* can then be used to relate sample to its
corresponding flags.

The script outputs a summary of the flags *flag_outlier_summary*, where the
flags for each sample is summed across all comparisons.

Two sets of plots are output: (ba_plots) Bland-Altman plots for pairwise
comparisons, and (outlier_dist_plots) Bar graphs of summarized flags which
allow for the identification of samples with many outlying data points or
compounds/peaks with many outlying points.

.. class:: infomark

The BA plot requires that there are not missing values. A row will be dropped
when a pairwise comparison has a missing value.

--------------------------------------------------------------------------------

**Input**

- Two input datasets are required. 

    **Wide Formatted Dataset:**

    A wide formatted dataset that contains measurements for each sample.::

        +----------+---------+---------+---------+-----+
        | Compound | sample1 | sample2 | sample3 | ... |
        +==========+=========+=========+=========+=====+
        | one      | 10      | 20      | 10      | ... |
        | two      | 5       | 22      | 30      | ... |
        | three    | 30      | 27      | 2       | ... |
        | four     | 32      | 17      | 8       | ... |
        | ...      | ...     | ...     | ...     | ... |
        +----------+---------+---------+---------+-----+

    **NOTE:** The sample IDs must match the sample IDs in the Design File (below). 
    Extra columns will automatically be ignored.


    **Design File:**
    A design file relating samples to various groups/treatment.::

        +----------+--------+
        | sampleID | group1 |
        +==========+========+
        | sample1  | g1     |
        | sample2  | g1     |
        | sample3  | g1     |
        | sample4  | g2     |
        | sample5  | g2     |
        | sample6  | g2     |
        | ...      | ...    |
        +----------+--------+

    **NOTE: You must have a column named *sampleID***
    and the values in this column must match the columns names in the wide
    formatted dataset. Extra columns will be ignored.

- In addition to your datasets, you need to provide:

    **Unique Compound ID**

    - The column name in your wide dataset that contains the unique IDs for
      your compounds. In our example dataset you would input *Compound*.

    **Outlier Cutoff**

    - Here we use several measures to identify features that are outliers or leverage points.
        - If the magnitude of the residuals from the linear regression on the
          BA-plot exceeds this threshold then a features is flagged as an
          outlier. This cutoff can be adjusted.
        - In addition, if a feature is identified as a leverage point using
          DFFITS or Cook's D then it is also flagged. This cannot be adjusted.

    **Sample Cutoff**

    - This cutoff sets the level to flag a sample. 
        - Using the above *Outlier Cutoff*, we identify samples that have a
          large number of features that are flagged as an outlier. The *Sample
          Cutoff* value, is the proportion of features within a sample that
          need to be flagged as outliers, for the sample to be flagged (1). The
          default value is 0.2, meaning that 20% of features need to be found
          as outliers for the sample to be flagged.

    **Feature Cutoff**

    - This cutoff sets the level to flag a feature. 
        - Using the above *Outlier Cutoff*, we identify features that are
          identified as outliers in the majority of samples. The *Feature
          Cutoff* value, is the proportion of samples a features needs to be
          found as an outlier for that that feature to be flagged (1). The
          default value is 0.05, meaning that a feature needs to be found
          as an outlier in 5% of samples to be flagged.

- If you only want to do within group comparisons (**suggested**) then you need
  to specify:

    **Group/Treatment**

    - The column name in your design file that contains group information. In
      our example design file we would put *group1*.

    **Group ID**

    - This option allows you to specify which groups to analyze (i.e., qc
      samples). Multiple group IDs can be specified by separating them with
      spaces. This option requires that **Group/Treatment** is also specified.

--------------------------------------------------------------------------------

**Output Files**

- This tool outputs 4 different files.

    **ba_plots** is a PDF of pairwise scatter plots and BA-plots.

    .. image:: ${static_path}/images/secim/ba_plot.png
        :height: 300
        :width: 600

    The left panel is a scatter plot comparing the two samples. Solid red line
    is a regression line and dotted lines are 95% CI. The right panel is a
    BA-plot where the x-axis is the mean between the two samples and y-axis is
    the difference. You expect to see a CIGAR shape centered at 0. Data
    highlighted in red indicate outliers. An data point was considered an
    outlier if it was flagged by any of 3 criteria. 

        * Regression Residuals were greater than the specified cutoff

        * Cook's D statistic was significant at a P-value cutoff of 0.5

        * DFFITS values exceeded then threshold value.

    **outlier_dist_plots** is a PDF of bar graphs for samples and
    compounds/peaks showing the number of data points that they had flagged as
    an outlier.

    .. image:: ${static_path}/images/secim/ba_plot_outlier_dist_sample.png
        :height: 300
        :width: 600

    .. image:: ${static_path}/images/secim/ba_plot_outlier_dist_feature.png
        :height: 300
        :width: 600

    The top panel shows the proportion of features that were outliers for each
    sample. The bottom panel shows the proportion of samples a feature was an
    outlier in. 

    **flag_sample** is a TSV containing a 0|1 flag for sample. If a sample is 1
    you should consider removing this sample.

    +----------+------------------------+
    | sampleID | flag_sample_BA_outlier |
    +==========+========================+
    | as101    | 0                      |
    +----------+------------------------+
    | as102    | 0                      |
    +----------+------------------------+
    | as103    | 1                      |
    +----------+------------------------+
    | ...      | ...                    |
    +----------+------------------------+


    **flag_feature** is a TSV containing a 0|1 flag for each feature. If a feature is 1
    you should consider removing this feature.

    +----------+-------------------------+
    | compound | flag_feature_BA_outlier |
    +==========+=========================+
    | one      | 0                       |
    +----------+-------------------------+
    | two      | 1                       |
    +----------+-------------------------+
    | three    | 0                       |
    +----------+-------------------------+
    | four     | 0                       |
    +----------+-------------------------+
    | ...      | ...                     |
    +----------+-------------------------+


</help>
</tool>

