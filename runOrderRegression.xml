<tool id="runOrder" name="Run Order Regression">
  <description>Look for linear relationships with run order.</description>
  <requirements>
    <requirement type="python-module">numpy</requirement>
    <requirement type="python-module">scipy</requirement>
    <requirement type="python-module">pandas</requirement>
    <requirement type="python-module">statsmodels</requirement>
    <requirement type="python-module">matplotlib</requirement>
  </requirements>
  <command interpreter="python">runOrderRegression.py
      --input $input
      --design $design
      --ID $uniqID
      --group $group
      --order $order
      --fig $order_plots
      --table $order_summary
  </command>
  <inputs>
    <param name="input" type="data" format="tabular" label="Wide Dataset" help="Input dataset in wide format and tab separated. If not tab separated see TIP below."/>
    <param name="design" type="data" format="tabular" label="Metadata File" help="Metadata file tab separated. Note you need a 'sampleID' column. If not tab separated see TIP below"/>
    <param name="uniqID" type="text" size="30" value="" label="Unique Compound ID" help="Name of the column in your Wide Dataset that has unique compound/gene IDs."/>
    <param name="group" type="text" size="30" value="" label="Group/Treatment" help="Name of the column in your Metadata File that contains group classifications."/>
    <param name="order" type="text" size="30" value="" label="Run Order ID" help="Name of the column in your Metadata File that contains run order."/>
  </inputs>
  <outputs>
    <data format="pdf" name="order_plots" />
    <data format="tabular" name="order_summary"/>
  </outputs>
<help>

.. class:: infomark

**TIP:**
If your data is not TAB delimited, use *Text Manipulation-&gt;Convert*

.. class:: warningmark

**WARNINGS:**
    - (1) This script automatically removes spaces and special characters from strings.
    - (2) If a compound name starts with a number it will prepend an '_'.

--------------------------------------------------------------------------------

**What it does**

This tool uses linear regression to identify potential relationships between sample run order and sample values.  If a linear relationship with run order is identified, further exploration may be warranted.   

--------------------------------------------------------------------------------

**Input**

- Two input datasets are required.

**Wide Formatted Dataset:**

A wide formatted dataset that contains measurements for each sample.::

    +----------+---------+---------+---------+-----+
    | Compound | sample1 | sample2 | sample3 | ... |
    +==========+=========+=========+=========+=====+
    | one      | 10      | 20      | 10      | ... |
    | two      | 5       | 22      | 30      | ... |
    | three    | 30      | 27      | 2       | ... |
    | four     | 32      | 17      | 8       | ... |
    | ...      | ...     | ...     | ...     | ... |
    +----------+---------+---------+---------+-----+

    **NOTE:** The sample IDs must match the sample IDs in the Design File (below).
    Extra columns will automatically be ignored.


**Metadata File:**
A metatdata file relating samples to various groups/treatment.::

    +----------+--------+
    | sampleID | group1 |
    +==========+========+
    | sample1  | g1     |
    | sample2  | g1     |
    | sample3  | g1     |
    | sample4  | g2     |
    | sample5  | g2     |
    | sample6  | g2     |
    | ...      | ...    |
    +----------+--------+

    **NOTE: You must have a column named *sampleID***
    and the values in this column must match the columns names in the wide
    formatted dataset. Extra columns will be ignored.

**In addition to your datasets, you need to provide:**

**Unique Compound ID**

    - The column name in your wide dataset that contains the unique IDs for
      your compounds. In our example dataset you would input *Compound*.

**Group/Treatment**

    - The column name in your Metadata file that contains group information. In
      our example design file we would put *group1*.

**Run Order ID**

    - The column name in your Metadata file that contains the order samples were
      run.

-----------------------------------------------------------------------------------

**Output Files**

- This tool outputs 2 different files:

    **runOrder_PDF** is a PDF containing the regression plots, one plot for each
    feature, where the x-axis is run order and the y-axis is value.  Only plots
    where the p- value was less than 0.05 are output as PDFs given that the
    prediction is no linear association of run order vs value (i.e., slope = 0).
    Features with a significant p-value are candidates for further investigation.

    .. image:: ${static_path}/images/secim/runOrder_plot.png
        :height: 300
        :width: 600

    The regression for Tyrosine is shown above. The values for each sample is
    plotted as a blue data point. They cyan colored line is the regression line
    with a slope of 0.193 and an R^2 0.165. Red lines indicate the confidence
    interval around the slope of the regression line.


    **runOrder_TSV** is a TSV file containing the regression summary information
    (slope, p-value and rSquared) in addtion to a 0/1 indicator flag for a
    signficant regression at a nominal p-value of (i) 0.05 and (ii) 0.10.


</help>
</tool>
